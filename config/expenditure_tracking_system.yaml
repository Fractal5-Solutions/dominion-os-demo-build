# PHI Expenditure Tracking System - Deep Work Configuration
# Generated: 2026-02-27
# Purpose: AI-powered expenditure extraction via Gmail API + Drive integration
# Approach: Zero-harm, comprehensive financial data harvesting with audit trail

system_metadata:
  version: "1.0.0"
  status: "DESIGN_READY"
  authority: "PHI Chief Autonomous Operations"
  owner: "matthewburbidge@fractal5solutions.com"
  audit_level: "MAXIMUM"
  encryption: "AES-256-GCM (required for financial data)"

# ==========================================
# GMAIL API EXTRACTION CONFIGURATION
# ==========================================
gmail_extraction:
  enabled: true
  primary_account: "matthewburbidge@fractal5solutions.com"

  # Search patterns for financial emails
  search_queries:
    invoices:
      - "subject:invoice"
      - "subject:receipt"
      - "subject:statement"
      - "from:*@stripe.com"
      - "from:*@gcp.google.com"
      - "from:billing@*"
      - "has:attachment filename:pdf"
      - "subject:(payment OR paid OR due)"

    subscriptions:
      - "subject:subscription"
      - "subject:(monthly OR annual) payment"
      - "from:*@github.com subject:billing"
      - "from:*@atlassian.com subject:invoice"
      - "from:*@jetbrains.com"
      - "from:*@adobe.com"

    cloud_services:
      - "from:*@google.com subject:(billing OR invoice)"
      - "from:*@aws.amazon.com"
      - "from:*@azure.com"
      - "from:*@cloudflare.com"
      - "from:*@digitalocean.com"

    domain_hosting:
      - "from:*@squarespace.com"
      - "from:*@godaddy.com"
      - "from:*@namecheap.com"
      - "subject:domain renewal"

    business_services:
      - "from:*@legalzoom.com"
      - "from:*@stripe.com"
      - "from:*@quickbooks.com"
      - "from:*@wave.com"
      - "subject:tax OR subject:filing"

  # Date range for historical extraction
  extraction_period:
    start_date: "2024-01-01"  # 2+ years of history
    end_date: "2026-02-27"
    ongoing: true

  # Extraction rules
  rules:
    max_emails_per_query: 500
    attachment_download: true
    attachment_types: ["pdf", "csv", "xlsx", "xls"]
    text_extraction: true
    metadata_capture:
      - "from"
      - "to"
      - "date"
      - "subject"
      - "labels"
      - "message_id"
      - "thread_id"

  # Rate limiting (Gmail API quotas)
  rate_limits:
    requests_per_second: 5
    requests_per_minute: 250
    daily_quota: 1000000000  # 1 billion quota units/day

# ==========================================
# DRIVE INTEGRATION CONFIGURATION
# ==========================================
drive_extraction:
  google_drive:
    enabled: true
    shared_drives:
      - name: "Fractal5 Solutions"
        path: "G:\\Shared drives\\Fractal5 Solutions"
        target_folders:
          - "Invoices"
          - "Receipts"
          - "Financial"
          - "Expenses"
          - "Banking"
          - "Tax Documents"
          - "Contracts"
        file_types: ["pdf", "xlsx", "csv", "png", "jpg"]

      - name: "Blue Wave Action Group Inc"
        path: "G:\\Shared drives\\Blue Wave Action Group Inc"
        target_folders:
          - "Invoices"
          - "Receipts"
          - "Financial"
          - "Campaign Expenses"
          - "Vendor Payments"
        file_types: ["pdf", "xlsx", "csv"]

      - name: "Plane4Grain"
        path: "G:\\Shared drives\\Plane4Grain"
        target_folders:
          - "Invoices"
          - "Receipts"
          - "Material Costs"
          - "Tool Purchases"
          - "Workshop Expenses"
        file_types: ["pdf", "xlsx", "csv", "jpg"]

  dropbox:
    enabled: true
    shared_folders:
      - url: "https://www.dropbox.com/scl/fo/hra0qfejrqx9eld90esmr/..."
        company: "Fractal5 Solutions"
        target_subfolders:
          - "Financial"
          - "Invoices"
          - "Tax Prep"

      - url: "https://www.dropbox.com/scl/fo/7dym190qmq82yxnu5j1tv/..."
        company: "Multiple"
        target_subfolders:
          - "Shared Financial"
          - "Cross-company Expenses"

# ==========================================
# EXPENDITURE DATA MODEL
# ==========================================
expenditure_schema:
  core_fields:
    # Identity
    expenditure_id: "UUID v4"
    company: "Fractal5 Solutions Inc | Blue Wave Action Group Inc | Plane4 Grain Inc"
    transaction_date: "YYYY-MM-DD"
    entry_date: "YYYY-MM-DD HH:MM:SS"

    # Financial
    amount: "Decimal (2 decimal places)"
    currency: "CAD | USD"
    exchange_rate: "Decimal (if applicable)"
    amount_cad: "Calculated CAD equivalent"

    # Categorization
    category: "See category_taxonomy below"
    subcategory: "Detailed classification"
    vendor: "Company name"
    description: "Human-readable description"

    # Tax and accounting
    tax_type: "GST | PST | HST | Sales Tax | None"
    tax_amount: "Decimal"
    tax_deductible: "Boolean"
    expense_type: "Operating | Capital | R&D | Marketing | Administrative"
    account_code: "QuickBooks/accounting system code"

    # Documentation
    receipt_url: "Cloud storage link"
    invoice_number: "Vendor invoice number"
    po_number: "Purchase order (if applicable)"
    payment_method: "Credit Card | Bank Transfer | Check | Cash | PayPal | Stripe"
    payment_status: "Paid | Pending | Overdue | Cancelled"

    # Source tracking
    data_source: "Gmail | Google Drive | Dropbox | Manual Entry"
    source_email_id: "Gmail message ID"
    source_file_path: "Drive/Dropbox path"
    extraction_confidence: "HIGH | MEDIUM | LOW"
    human_verified: "Boolean"

    # Audit
    created_by: "PHI Chief | matthewburbidge@fractal5solutions.com"
    modified_by: "User identifier"
    created_at: "Timestamp"
    modified_at: "Timestamp"
    ledger_hash: "SHA-256 hash"

  # Comprehensive expense categorization
  category_taxonomy:
    infrastructure:
      - "Cloud Computing (GCP, AWS, Azure)"
      - "Domain & Hosting (Squarespace, GoDaddy)"
      - "CDN & Network (Cloudflare)"
      - "Storage (Google Drive, Dropbox, S3)"
      - "Database Services"
      - "Monitoring & Logging"

    software_saas:
      - "Development Tools (GitHub, GitLab, JetBrains)"
      - "Project Management (Jira, Asana, Notion)"
      - "Communication (Slack, Zoom, Google Workspace)"
      - "Design Tools (Figma, Adobe Creative Cloud)"
      - "AI Services (OpenAI, Anthropic, Cohere)"
      - "Security Tools (1Password, Okta)"

    professional_services:
      - "Legal (Incorporation, Contracts, Compliance)"
      - "Accounting & Bookkeeping"
      - "Consulting"
      - "Freelance Development"
      - "Marketing Agency"

    marketing_sales:
      - "Advertising (Google Ads, Facebook Ads)"
      - "SEO & Content Marketing"
      - "Email Marketing (Mailchimp, SendGrid)"
      - "Social Media Tools"
      - "Analytics (Google Analytics, Mixpanel)"

    operational:
      - "Office Supplies"
      - "Equipment & Hardware"
      - "Software Licenses"
      - "Insurance (Business, Liability, Cyber)"
      - "Banking Fees"
      - "Payment Processing Fees (Stripe, PayPal)"

    rd_innovation:
      - "AI Model Training"
      - "Research Subscriptions"
      - "Experimental Infrastructure"
      - "Prototype Development"
      - "Testing Services"

    human_capital:
      - "Contractor Payments"
      - "Recruitment Fees"
      - "Training & Education"
      - "Team Events"

    compliance_governance:
      - "Business Licenses"
      - "Tax Filings"
      - "Regulatory Compliance"
      - "Audits"

    plane4_grain_specific:
      - "Wood & Materials"
      - "Tools & Equipment"
      - "Workshop Rent/Utilities"
      - "Finishing Supplies"
      - "Shipping & Packaging"

    blue_wave_specific:
      - "Campaign Technology"
      - "Voter Database Subscriptions"
      - "Political Analytics Tools"
      - "Event Platforms"

# ==========================================
# AI EXTRACTION PATTERNS
# ==========================================
ai_extraction:
  # Patterns for email body parsing
  email_patterns:
    amount_detection:
      - regex: '\$([0-9,]+\.[0-9]{2})'
      - regex: 'CAD\s*([0-9,]+\.[0-9]{2})'
      - regex: 'USD\s*([0-9,]+\.[0-9]{2})'
      - regex: 'Total[:|\s]+\$?([0-9,]+\.[0-9]{2})'
      - regex: 'Amount Due[:|\s]+\$?([0-9,]+\.[0-9]{2})'

    date_detection:
      - regex: 'Invoice Date[:|\s]+([0-9]{4}-[0-9]{2}-[0-9]{2})'
      - regex: 'Due Date[:|\s]+([0-9]{4}-[0-9]{2}-[0-9]{2})'
      - regex: 'Payment Date[:|\s]+([0-9]{4}-[0-9]{2}-[0-9]{2})'

    invoice_number:
      - regex: 'Invoice #[:|\s]+([A-Z0-9-]+)'
      - regex: 'Receipt #[:|\s]+([A-Z0-9-]+)'
      - regex: 'Order ID[:|\s]+([A-Z0-9-]+)'

    vendor_detection:
      - "Extract from From: email address"
      - "Parse company name from email signature"
      - "Extract from invoice header"

  # PDF invoice parsing (if OCR available)
  pdf_extraction:
    ocr_enabled: true
    target_fields:
      - "Invoice Number"
      - "Date"
      - "Amount"
      - "Tax"
      - "Vendor Name"
      - "Vendor Address"
      - "Payment Terms"
      - "Line Items"

    structured_extraction:
      - "Detect table structures"
      - "Extract line item details"
      - "Identify totals and subtotals"
      - "Capture payment information"

# ==========================================
# AUTOMATION WORKFLOW
# ==========================================
workflow:
  step_1_gmail_scan:
    name: "Gmail Historical Scan"
    action: "Execute all search queries against Gmail API"
    output: "Raw email dataset with attachments"
    frequency: "One-time (historical) + Daily (ongoing)"

  step_2_drive_sync:
    name: "Drive & Dropbox Sync"
    action: "Scan shared drives for financial documents"
    output: "File inventory with metadata"
    frequency: "Daily"

  step_3_ai_extraction:
    name: "AI-Powered Data Extraction"
    action: "Parse emails and PDFs using regex + AI models"
    models:
      - "GPT-4 for complex invoice parsing"
      - "Claude for structured data extraction"
      - "Local regex for simple patterns"
    output: "Structured expenditure records"
    confidence_threshold: 0.85

  step_4_deduplication:
    name: "Duplicate Detection"
    action: "Identify and merge duplicate entries"
    matching_fields:
      - "amount"
      - "date"
      - "vendor"
      - "invoice_number"
    fuzzy_matching: true

  step_5_validation:
    name: "Data Validation & Quality Check"
    checks:
      - "Amount > 0"
      - "Date within valid range"
      - "Category assigned"
      - "Company identified"
      - "Currency specified"
    low_confidence_flagging: true

  step_6_human_review:
    name: "Human Verification Queue"
    criteria:
      - "Confidence < 85%"
      - "Amount > $1000"
      - "Uncategorized"
      - "Missing receipt"
    interface: "Web dashboard for Matthew's review"

  step_7_ledger_commit:
    name: "Ledger & Database Commit"
    action: "Write verified expenditures to system"
    database: "PostgreSQL with encryption"
    ledger: "SHA-256 blockchain audit trail"
    backup: "Automated daily backups"

  step_8_reporting:
    name: "Generate Financial Reports"
    reports:
      - "Monthly expenditure summary by company"
      - "Category breakdown"
      - "Vendor analysis"
      - "Tax deduction summary"
      - "Budget vs. actual comparison"
      - "Cash flow projection"

# ==========================================
# GMAIL API SETUP (Technical Requirements)
# ==========================================
gmail_api_setup:
  prerequisites:
    - "Google Cloud Project with Gmail API enabled"
    - "OAuth 2.0 credentials configured"
    - "Service account with domain-wide delegation (optional)"
    - "Appropriate scopes: gmail.readonly, gmail.modify"

  authentication_flow:
    method: "OAuth 2.0"
    scopes:
      - "https://www.googleapis.com/auth/gmail.readonly"
      - "https://www.googleapis.com/auth/gmail.modify"  # For labeling processed emails
    token_storage: "Encrypted credentials file"
    refresh_token: "Automatic refresh on expiry"

  implementation:
    library: "google-auth + google-api-python-client"
    language: "Python 3.11+"
    error_handling: "Exponential backoff with retry"
    logging: "Comprehensive audit log for all API calls"

# ==========================================
# SECURITY & PRIVACY
# ==========================================
security:
  data_encryption:
    at_rest: "AES-256-GCM for all financial data"
    in_transit: "TLS 1.3 for API communications"
    key_management: "Google KMS + local HSM backup"

  access_control:
    matthew_only: true
    phi_chief: "Read-only for automation, write requires approval"
    multi_factor: "Required for financial data access"
    session_timeout: "15 minutes for financial views"

  audit_trail:
    all_access_logged: true
    all_modifications_logged: true
    retention_period: "7 years (tax compliance)"
    immutable_ledger: true

  pii_handling:
    vendor_contact_info: "Encrypted"
    banking_details: "Never stored (reference only)"
    tax_ids: "Encrypted with separate key"

  compliance:
    - "PIPEDA (Canadian privacy law)"
    - "CRA record-keeping requirements (7 years)"
    - "GDPR (if EU vendors involved)"
    - "PCI-DSS (if credit card data in receipts)"

# ==========================================
# DASHBOARD & REPORTING
# ==========================================
dashboard_features:
  real_time_metrics:
    - "Total expenditures MTD, YTD"
    - "Expenditures by company"
    - "Expenditures by category"
    - "Largest expenses (top 10)"
    - "Pending reviews count"
    - "Extraction confidence distribution"

  interactive_views:
    - "Time series charts (daily, monthly, yearly)"
    - "Category pie charts"
    - "Vendor rankings"
    - "Budget burn rate"
    - "Tax deduction tracker"
    - "Subscription calendar (renewal dates)"

  exports:
    - "CSV for accounting import"
    - "PDF reports for tax filing"
    - "QuickBooks integration (API)"
    - "Excel with pivot tables"
    - "JSON for custom analysis"

  alerts:
    - "Large expense detected (> threshold)"
    - "Unusual spending pattern"
    - "Subscription renewal approaching"
    - "Budget exceeded"
    - "Missing receipts for tax-deductible items"

# ==========================================
# INTEGRATION POINTS
# ==========================================
integrations:
  bims_integration:
    file: "config/organizational-authority.json"
    sync: "Expenditure data enriches company profiles"
    bidirectional: false  # BIMS → Expenditure only

  accounting_software:
    quickbooks_online:
      enabled: "PLANNED"
      api_integration: true
      sync_frequency: "Daily"
      direction: "Export from PHI → Import to QuickBooks"

    wave_accounting:
      enabled: "ALTERNATIVE"
      csv_export: true
      manual_import: true

  banking:
    bank_feeds:
      enabled: "PLANNED"
      description: "Import bank transactions for reconciliation"
      providers: ["Plaid", "Yodlee", "MX"]

  tax_software:
    turbotax_export:
      enabled: "PLANNED"
      format: "CSV with CRA categories"

    cra_electronic_filing:
      enabled: "FUTURE"
      description: "Direct integration with CRA systems"

# ==========================================
# IMPLEMENTATION ROADMAP
# ==========================================
implementation:
  phase_1_foundation:
    duration: "1-2 weeks"
    tasks:
      - "Set up Gmail API credentials"
      - "Implement basic email scanning"
      - "Create expenditure database schema"
      - "Build simple extraction pipeline"
      - "Test with 100 sample emails"
    deliverable: "MVP extraction system"

  phase_2_intelligence:
    duration: "2-3 weeks"
    tasks:
      - "Integrate AI models for parsing"
      - "Build deduplication logic"
      - "Implement confidence scoring"
      - "Create human review interface"
      - "Add Drive/Dropbox scanning"
    deliverable: "Intelligent extraction with 85%+ accuracy"

  phase_3_automation:
    duration: "1-2 weeks"
    tasks:
      - "Automate daily scans"
      - "Build email labeling (processed/unprocessed)"
      - "Create alert system"
      - "Implement ledger integration"
      - "Set up encrypted storage"
    deliverable: "Fully automated pipeline"

  phase_4_reporting:
    duration: "2-3 weeks"
    tasks:
      - "Build web dashboard"
      - "Create export templates"
      - "QuickBooks integration"
      - "Tax report generation"
      - "Budget tracking features"
    deliverable: "Complete financial intelligence platform"

# ==========================================
# SUCCESS METRICS
# ==========================================
success_metrics:
  extraction_accuracy: "> 90% correct categorization"
  coverage: "> 95% of expenses captured"
  automation_rate: "> 80% processed without human intervention"
  time_savings: "Reduce manual entry time by 95%"
  audit_readiness: "100% documentation coverage"
  tax_compliance: "All CRA requirements met"

# ==========================================
# CURRENT STATUS
# ==========================================
status:
  design_complete: true
  gmail_api_configured: false
  drive_access_confirmed: false
  database_schema: "PENDING"
  extraction_pipeline: "NOT_STARTED"
  dashboard: "NOT_STARTED"

  next_actions:
    - "Matthew: Configure Gmail API OAuth credentials"
    - "Matthew: Grant PHI Chief access to financial folders in Drive"
    - "PHI Chief: Create expenditure database schema"
    - "PHI Chief: Build Gmail scanning prototype"
    - "PHI Chief: Test extraction with 10 sample invoices"
