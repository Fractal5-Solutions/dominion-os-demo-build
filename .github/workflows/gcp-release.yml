name: gcp-release
on:
  push:
    branches: [ main ]
  workflow_dispatch:
permissions:
  contents: read
  id-token: write
jobs:
  release:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
      GCP_WIF_SA_EMAIL: ${{ secrets.GCP_WIF_SA_EMAIL }}
    steps:
      - name: Install deps (gcloud + jq)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl gnupg jq
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          sudo apt-get update -y && sudo apt-get install -y google-cloud-cli
      - name: Assert secrets present
        run: test -n "$GCP_PROJECT_ID" && test -n "$GCP_WIF_PROVIDER" && test -n "$GCP_WIF_SA_EMAIL"
      - name: Fetch OIDC ID token
        run: |
          curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=gha" | jq -r .value > idt.txt
      - name: Exchange for GCP access token
        run: |
          AT=$(curl -sS -H "Content-Type: application/json" \
             -d "{\"audience\":\"//$GCP_WIF_PROVIDER\",\"grantType\":\"urn:ietf:params:oauth:grant-type:token-exchange\",\"requested_token_type\":\"urn:ietf:params:oauth:token-type:access_token\",\"subject_token_type\":\"urn:ietf:params:oauth:token-type:id_token\",\"subject_token\":\"$(cat idt.txt)\",\"scope\":\"https://www.googleapis.com/auth/cloud-platform\"}" \
             https://sts.googleapis.com/v1/token | jq -r .access_token)
          echo "$AT" > access_token.txt
      - name: Configure gcloud (placeholder)
        run: |
          gcloud config set project "$GCP_PROJECT_ID"
          gcloud auth activate-service-account "$GCP_WIF_SA_EMAIL" --key-file <(echo '{}') || true
      - name: Release step (placeholder)
        run: |
          echo "Ready for gcloud deploys."
