name: gcp-release

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  SERVICE_NAME: ${{ vars.GCP_SERVICE_NAME || 'dominion-demo-build' }}
  # Expected to be an Artifact Registry image reference (tag or digest)
  SIGN_IMAGE: ${{ secrets.SIGN_IMAGE }}
  ALLOW_UNAUTH: ${{ vars.GCP_ALLOW_UNAUTH || 'false' }}

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7

      - name: Auth GCP (Workload Identity)
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2.1.13 pinned
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SA_EMAIL }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@e427ad8a34f8676edf47cf7d7925499adf3eb74f # v2.2.1
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth (Artifact Registry)
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SIGN_IMAGE:-}" ]; then
            echo "Missing secrets.SIGN_IMAGE (expected Artifact Registry image path)" >&2
            exit 1
          fi
          base="${SIGN_IMAGE%@*}"
          base="${base%:*}"
          host="$(echo "$base" | cut -d'/' -f1)"
          gcloud auth configure-docker "$host" --quiet
          echo "IMAGE_BASE=$base" >> "$GITHUB_ENV"

      - name: Build and push image (sha + latest)
        shell: bash
        run: |
          set -euo pipefail
          image_sha="${IMAGE_BASE}:${GITHUB_SHA}"
          image_latest="${IMAGE_BASE}:latest"
          docker build -t "$image_sha" -t "$image_latest" .
          docker push "$image_sha"
          docker push "$image_latest"

      - name: Resolve digest
        id: digest
        shell: bash
        run: |
          set -euo pipefail
          image_sha="${IMAGE_BASE}:${GITHUB_SHA}"
          digest=$(gcloud artifacts docker images describe "$image_sha" --project "$PROJECT_ID" --format='value(image_summary.digest)' 2>/dev/null || true)
          if [ -z "$digest" ]; then
            digest=$(gcloud container images describe "$image_sha" --format='value(image_summary.digest)' 2>/dev/null || true)
          fi
          if [ -z "$digest" ]; then
            echo "ERROR: Failed to resolve digest for $image_sha" >&2
            exit 1
          fi
          image_ref="${IMAGE_BASE}@${digest}"
          if ! printf '%s' "$image_ref" | grep -q "@sha256:"; then
            echo "ERROR: Expected digest-pinned image ref, got $image_ref" >&2
            exit 1
          fi
          echo "image_ref=$image_ref" >> "$GITHUB_OUTPUT"

      - name: Deploy to Cloud Run (digest)
        shell: bash
        run: |
          set -euo pipefail
          auth_flag="--no-allow-unauthenticated"
          if [[ "${ALLOW_UNAUTH,,}" == "true" ]]; then auth_flag="--allow-unauthenticated"; fi
          gcloud run deploy "$SERVICE_NAME" \
            --image "${{ steps.digest.outputs.image_ref }}" \
            --region "$REGION" \
            --project "$PROJECT_ID" \
            $auth_flag \
            --platform managed \
            --quiet

          url=$(gcloud run services describe "$SERVICE_NAME" --region "$REGION" --project "$PROJECT_ID" --format='value(status.url)')
          echo "SERVICE_URL=$url" >> "$GITHUB_ENV"

      - name: Health check
        shell: bash
        run: |
          set -euo pipefail
          curl -fsS "$SERVICE_URL/healthz" >/dev/null
