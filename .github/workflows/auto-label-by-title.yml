name: Auto Label by Title

on:
  pull_request:
    types: [opened, edited, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure labels exist (conventional types)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          names=(feature fix docs refactor test chore ci build perf style revert)
          colors=(1D76DB D73A4A 0075CA A2EEEF BFDADC D4C5F9 BFD4F2 FBCA04 C2E0C6 FEF2C0 E99695)
          descs=(
            "Feature work"
            "Bug fix"
            "Documentation"
            "Refactoring"
            "Tests"
            "Chores and maintenance"
            "Continuous Integration"
            "Build system or dependencies"
            "Performance improvements"
            "Code style (formatting, missing semi-colons, etc)"
            "Reverts a previous commit"
          )
          for i in "${!names[@]}"; do
            name="${names[$i]}"; color="${colors[$i]}"; desc="${descs[$i]}"
            if ! curl -fsS -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$repo/labels/$name" >/dev/null 2>&1; then
              curl -fsS -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$repo/labels" \
                -d "{\"name\":\"$name\",\"color\":\"$color\",\"description\":\"$desc\"}" || true
            fi
          done

      - name: Auto-label by PR title
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set +e
          repo="${{ github.repository }}"
          shopt -s nocasematch || true
          title="$PR_TITLE"
          # Skip labeling for WIP titles
          if [[ "$title" =~ ^wip(:|\(|\s) ]]; then
            echo "WIP detected; skipping auto-label. Title: $title"
            exit 0
          fi
          label=""
          # Map deps to build (e.g., deps:..., chore(deps): ...)
          if [[ "$title" =~ ^deps(:|\(|\s) || "$title" =~ ^chore\(deps\) || "$title" =~ ^bump(:|\(|\s) ]]; then
            label="build"
          elif [[ "$title" =~ ^feat(:|\(|\s) || "$title" =~ ^feature(:|\(|\s) ]]; then
            label="feature"
          elif [[ "$title" =~ ^fix(:|\(|\s) || "$title" =~ ^hotfix(:|\(|\s) ]]; then
            label="fix"
          elif [[ "$title" =~ ^docs(:|\(|\s) ]]; then
            label="docs"
          elif [[ "$title" =~ ^refactor(:|\(|\s) ]]; then
            label="refactor"
          elif [[ "$title" =~ ^tests?(:|\(|\s) ]]; then
            label="test"
          elif [[ "$title" =~ ^chore(:|\(|\s) ]]; then
            label="chore"
          elif [[ "$title" =~ ^ci(:|\(|\s) ]]; then
            label="ci"
          elif [[ "$title" =~ ^build(:|\(|\s) ]]; then
            label="build"
          elif [[ "$title" =~ ^perf(:|\(|\s) ]]; then
            label="perf"
          elif [[ "$title" =~ ^style(:|\(|\s) ]]; then
            label="style"
          elif [[ "$title" =~ ^revert(:|\(|\s) ]]; then
            label="revert"
          fi
          if [ -n "$label" ]; then
            echo "Applying label: $label for title: $title"
            curl -fsS -X POST -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$repo/issues/$PR_NUMBER/labels" \
              -d "{\"labels\":[\"$label\"]}"
          else
            echo "No matching label for title: $title"
          fi
