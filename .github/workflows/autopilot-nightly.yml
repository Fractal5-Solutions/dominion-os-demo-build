name: Autopilot Nightly

on:
  schedule:
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

concurrency:
  group: autopilot-${{ github.repository }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      project: ${{ steps.normalize.outputs.project }}
      image: ${{ steps.normalize.outputs.image }}
      key_uri: ${{ steps.normalize.outputs.key_uri }}
      auth_mode: ${{ steps.normalize.outputs.auth_mode }}
      wif_provider: ${{ steps.normalize.outputs.wif_provider }}
      wif_sa_email: ${{ steps.normalize.outputs.wif_sa_email }}
      region: ${{ steps.normalize.outputs.region }}
      service_name: ${{ steps.normalize.outputs.service_name }}
      allow_unauth: ${{ steps.normalize.outputs.allow_unauth }}
    steps:
      - name: Validate secrets and config
        id: normalize
        shell: bash
        env:
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          SIGN_IMAGE: ${{ secrets.SIGN_IMAGE }}
          SIGN_KEY_URI: ${{ secrets.SIGN_KEY_URI }}
          COSIGN_KEY_URI: ${{ secrets.COSIGN_KEY_URI }}
          GCP_WIF_PROVIDER: ${{ secrets.GCP_WIF_PROVIDER }}
          GCP_WIF_SA_EMAIL: ${{ secrets.GCP_WIF_SA_EMAIL }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_REGION: ${{ vars.GCP_REGION }}
          GCP_SERVICE_NAME: ${{ vars.GCP_SERVICE_NAME }}
          GCP_ALLOW_UNAUTH: ${{ vars.GCP_ALLOW_UNAUTH }}
        run: |
          set -euo pipefail
          missing=()
          if [ -z "${GCP_PROJECT_ID:-}" ]; then missing+=("GCP_PROJECT_ID"); fi
          if [ -z "${SIGN_IMAGE:-}" ]; then missing+=("SIGN_IMAGE"); fi
          key_uri="${SIGN_KEY_URI:-${COSIGN_KEY_URI:-}}"
          if [ -z "$key_uri" ]; then missing+=("SIGN_KEY_URI or COSIGN_KEY_URI"); fi
          auth_mode=""
          if [ -n "${GCP_WIF_PROVIDER:-}" ] && [ -n "${GCP_WIF_SA_EMAIL:-}" ]; then
            auth_mode="wif"
          elif [ -n "${GCP_SA_KEY:-}" ]; then
            auth_mode="sa_key"
          else
            missing+=("GCP_WIF_PROVIDER+GCP_WIF_SA_EMAIL or GCP_SA_KEY")
          fi
          if [ -z "${GCP_SERVICE_NAME:-}" ]; then
            missing+=("vars.GCP_SERVICE_NAME")
          fi
          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required secrets/config: ${missing[*]}" >&2
            echo "Set in repo secrets/variables. Required: GCP_PROJECT_ID, SIGN_IMAGE, SIGN_KEY_URI (or COSIGN_KEY_URI), auth (GCP_WIF_PROVIDER+GCP_WIF_SA_EMAIL or GCP_SA_KEY), and vars.GCP_SERVICE_NAME." >&2
            exit 1
          fi
          region="${GCP_REGION:-us-central1}"
          allow_unauth="${GCP_ALLOW_UNAUTH:-false}"
          echo "project=$GCP_PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "image=$SIGN_IMAGE" >> "$GITHUB_OUTPUT"
          echo "key_uri=$key_uri" >> "$GITHUB_OUTPUT"
          echo "auth_mode=$auth_mode" >> "$GITHUB_OUTPUT"
          echo "wif_provider=${GCP_WIF_PROVIDER:-}" >> "$GITHUB_OUTPUT"
          echo "wif_sa_email=${GCP_WIF_SA_EMAIL:-}" >> "$GITHUB_OUTPUT"
          echo "region=$region" >> "$GITHUB_OUTPUT"
          echo "service_name=$GCP_SERVICE_NAME" >> "$GITHUB_OUTPUT"
          echo "allow_unauth=$allow_unauth" >> "$GITHUB_OUTPUT"

  autopilot:
    needs: preflight
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      changes_detected: ${{ steps.changes.outputs.changes_detected }}
      pr_url: ${{ steps.cpr.outputs.pull-request-url }}
      digest: ${{ steps.digest.outputs.digest }}
    env:
      PROJECT: ${{ needs.preflight.outputs.project }}
      IMAGE: ${{ needs.preflight.outputs.image }}
      KEY_URI: ${{ needs.preflight.outputs.key_uri }}
      REGION: ${{ needs.preflight.outputs.region }}
      SERVICE_NAME: ${{ needs.preflight.outputs.service_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0

      - name: Checkout dominion-os-1.0
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          repository: Fractal5-Solutions/dominion-os-1.0
          path: dominion-os-1.0
          token: ${{ secrets.GH_AUTOPILOT_TOKEN || github.token }}
          fetch-depth: 0

      - name: Auth GCP via WIF
        if: ${{ needs.preflight.outputs.auth_mode == 'wif' }}
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935a # v2.1.3
        with:
          workload_identity_provider: ${{ needs.preflight.outputs.wif_provider }}
          service_account: ${{ needs.preflight.outputs.wif_sa_email }}

      - name: Auth GCP via SA key
        if: ${{ needs.preflight.outputs.auth_mode == 'sa_key' }}
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935a # v2.1.3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@e30db14379863a8c79331b04a9969f4c1e225e0b # v2.1.0
        with:
          project_id: ${{ env.PROJECT }}

      - name: Setup Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4
        with:
          python-version: "3.x"

      - name: Prepare output directory
        run: |
          mkdir -p out/autopilot

      - name: Run demo autopilot
        id: run
        shell: bash
        env:
          DOMINION_OS_PATH: ${{ github.workspace }}/dominion-os-1.0
          AUTOPILOT_SCALE: ${{ vars.AUTOPILOT_SCALE || 'large' }}
          AUTOPILOT_DURATION: ${{ vars.AUTOPILOT_DURATION || '180' }}
          AUTOPILOT_RUNS: ${{ vars.AUTOPILOT_RUNS || '1' }}
          AUTOPILOT_INTERVAL_MS: ${{ vars.AUTOPILOT_INTERVAL_MS || '0' }}
        run: |
          set -euo pipefail
          log="out/autopilot/autopilot-${{ github.run_id }}.log"
          python demo_build.py autopilot --scale "$AUTOPILOT_SCALE" --duration "$AUTOPILOT_DURATION" --runs "$AUTOPILOT_RUNS" --interval-ms "$AUTOPILOT_INTERVAL_MS" 2>&1 | tee "$log"

      - name: Ensure image digest
        id: digest
        shell: bash
        env:
          PROJECT: ${{ env.PROJECT }}
          IMAGE: ${{ env.IMAGE }}
        run: |
          set -euo pipefail
          mkdir -p out/autopilot
          digest=""
          for p in image-digest.txt; do
            if [ -f "$p" ]; then
              digest="$(cat "$p" | tr -d '[:space:]')"
              break
            fi
          done
          if [ -z "$digest" ]; then
            echo "image-digest.txt not found; resolving digest for $IMAGE"
            digest=$(gcloud artifacts docker images describe "$IMAGE" --project "$PROJECT" --format='value(image_summary.digest)' 2>/dev/null || true)
            if [ -z "$digest" ]; then
              digest=$(gcloud container images describe "$IMAGE" --format='value(image_summary.digest)' 2>/dev/null || true)
            fi
          fi
          if [ -z "$digest" ]; then
            echo "Unable to resolve digest for $IMAGE" >&2
            exit 1
          fi
          digest="$(echo "$digest" | tr -d '[:space:]')"
          echo "$digest" > out/autopilot/image-digest.txt
          echo "$digest" > image-digest.txt
          echo "digest=$digest" >> "$GITHUB_OUTPUT"

      - name: Detect repo changes
        id: changes
        shell: bash
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changes_detected=true" >> "$GITHUB_OUTPUT"
          else
            echo "changes_detected=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create/update autopilot PR
        id: cpr
        if: ${{ steps.changes.outputs.changes_detected == 'true' }}
        uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
        with:
          token: ${{ github.token }}
          commit-message: "chore(autopilot): nightly updates"
          title: "Autopilot nightly updates"
          body: "Automated nightly autopilot changes."
          branch: "autopilot/nightly"
          base: "main"
          delete-branch: false

      - name: Write report.json
        if: always()
        shell: bash
        env:
          AUTOPILOT_OUTCOME: ${{ steps.run.outcome }}
          DIGEST: ${{ steps.digest.outputs.digest }}
          CHANGES_DETECTED: ${{ steps.changes.outputs.changes_detected }}
          PR_URL: ${{ steps.cpr.outputs.pull-request-url }}
        run: |
          set -euo pipefail
          mkdir -p out/autopilot
          python - <<'PY'
import json, os, datetime
changes = os.environ.get("CHANGES_DETECTED")
pr_url = os.environ.get("PR_URL") or ""
push = bool(pr_url or changes == "true")
report = {
    "repo": os.environ.get("GITHUB_REPOSITORY"),
    "branch": os.environ.get("GITHUB_REF_NAME"),
    "sha": os.environ.get("GITHUB_SHA"),
    "run_id": os.environ.get("GITHUB_RUN_ID"),
    "run_attempt": os.environ.get("GITHUB_RUN_ATTEMPT"),
    "autopilot_outcome": os.environ.get("AUTOPILOT_OUTCOME"),
    "digest": os.environ.get("DIGEST") or "",
    "changes_detected": changes or "unknown",
    "commits_created": "yes" if changes == "true" else "no" if changes == "false" else "unknown",
    "push_performed": "yes" if push else "no",
    "pr_url": pr_url,
    "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
}
with open("out/autopilot/report.json", "w", encoding="utf-8") as f:
    json.dump(report, f, indent=2)
PY

      - name: Upload autopilot artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: autopilot-output
          path: |
            out/autopilot/**
            dist/**
            image-digest.txt

  deploy:
    needs: [preflight, autopilot]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      PROJECT: ${{ needs.preflight.outputs.project }}
      REGION: ${{ needs.preflight.outputs.region }}
      SERVICE_NAME: ${{ needs.preflight.outputs.service_name }}
      IMAGE: ${{ needs.preflight.outputs.image }}
      ALLOW_UNAUTH: ${{ needs.preflight.outputs.allow_unauth }}
    steps:
      - name: Download autopilot artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: autopilot-output
          path: autopilot-output

      - name: Auth GCP via WIF
        if: ${{ needs.preflight.outputs.auth_mode == 'wif' }}
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935a # v2.1.3
        with:
          workload_identity_provider: ${{ needs.preflight.outputs.wif_provider }}
          service_account: ${{ needs.preflight.outputs.wif_sa_email }}

      - name: Auth GCP via SA key
        if: ${{ needs.preflight.outputs.auth_mode == 'sa_key' }}
        uses: google-github-actions/auth@71f986410dfbc7added4569d411d040a91dc6935a # v2.1.3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@e30db14379863a8c79331b04a9969f4c1e225e0b # v2.1.0
        with:
          project_id: ${{ env.PROJECT }}

      - name: Deploy to Cloud Run (digest)
        id: deploy
        shell: bash
        run: |
          set -euo pipefail
          digest_path="autopilot-output/out/autopilot/image-digest.txt"
          if [ ! -f "$digest_path" ]; then
            digest_path="autopilot-output/image-digest.txt"
          fi
          if [ ! -f "$digest_path" ]; then
            echo "image-digest.txt not found in autopilot artifacts" >&2
            exit 1
          fi
          digest="$(cat "$digest_path" | tr -d '[:space:]')"
          if [ -z "$digest" ]; then
            echo "image digest empty" >&2
            exit 1
          fi
          if [[ "$digest" != sha256:* ]]; then
            digest="sha256:$digest"
          fi
          if [[ "$IMAGE" == *@sha256:* ]]; then
            image_ref="$IMAGE"
          else
            image_ref="${IMAGE%:*}@${digest}"
          fi
          auth_flag="--no-allow-unauthenticated"
          if [[ "${ALLOW_UNAUTH,,}" == "true" ]]; then auth_flag="--allow-unauthenticated"; fi
          gcloud run deploy "$SERVICE_NAME" --image "$image_ref" --region "$REGION" --project "$PROJECT" $auth_flag --platform managed --quiet
          url=$(gcloud run services describe "$SERVICE_NAME" --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          rev=$(gcloud run services describe "$SERVICE_NAME" --region "$REGION" --project "$PROJECT" --format='value(status.latestReadyRevisionName)')
          mkdir -p out/autopilot
          export IMAGE_REF="$image_ref"
          export SERVICE_URL="$url"
          export SERVICE_REV="$rev"
          python - <<'PY'
import json, os
payload = {
    "service": os.environ.get("SERVICE_NAME"),
    "region": os.environ.get("REGION"),
    "project": os.environ.get("PROJECT"),
    "image_ref": os.environ.get("IMAGE_REF"),
    "url": os.environ.get("SERVICE_URL"),
    "revision": os.environ.get("SERVICE_REV"),
}
with open("out/autopilot/deploy.json", "w", encoding="utf-8") as f:
    json.dump(payload, f, indent=2)
PY

      - name: Upload deploy artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: deploy-output
          path: out/autopilot/deploy.json

  report:
    needs: [preflight, autopilot, deploy]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download autopilot artifacts
        if: ${{ needs.autopilot.result != 'skipped' }}
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: autopilot-output
          path: autopilot-output

      - name: Download deploy artifacts
        if: ${{ needs.deploy.result != 'skipped' }}
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: deploy-output
          path: deploy-output

      - name: Write summary
        shell: bash
        env:
          PREFLIGHT_RESULT: ${{ needs.preflight.result }}
          AUTOPILOT_RESULT: ${{ needs.autopilot.result }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
          CHANGES_DETECTED: ${{ needs.autopilot.outputs.changes_detected }}
          PR_URL: ${{ needs.autopilot.outputs.pr_url }}
        run: |
          set -euo pipefail
          digest=""
          if [ -f autopilot-output/out/autopilot/image-digest.txt ]; then
            digest="$(cat autopilot-output/out/autopilot/image-digest.txt | tr -d '[:space:]')"
          fi
          deploy_url=""
          if [ -f deploy-output/out/autopilot/deploy.json ]; then
            deploy_url=$(python - <<'PY'
import json
with open('deploy-output/out/autopilot/deploy.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(data.get('url', ''))
PY
)
          fi
          commits="n/a"
          push="n/a"
          if [ "${CHANGES_DETECTED:-}" = "true" ]; then
            commits="yes"
          elif [ "${CHANGES_DETECTED:-}" = "false" ]; then
            commits="no"
          fi
          if [ -n "${PR_URL:-}" ]; then
            push="yes"
          elif [ "${CHANGES_DETECTED:-}" = "false" ]; then
            push="no"
          fi
          run_url="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          {
            echo "## Autopilot Nightly Report"
            echo ""
            echo "- repo: ${GITHUB_REPOSITORY}"
            echo "- branch: ${GITHUB_REF_NAME}"
            echo "- sha: ${GITHUB_SHA}"
            echo "- preflight: ${PREFLIGHT_RESULT}"
            echo "- autopilot: ${AUTOPILOT_RESULT}"
            echo "- deploy: ${DEPLOY_RESULT}"
            echo "- digest: ${digest:-n/a}"
            echo "- commits_created: ${commits}"
            echo "- push: ${push}"
            echo "- pr: ${PR_URL:-n/a}"
            echo "- deploy_url: ${deploy_url:-n/a}"
            echo "- run: ${run_url}"
          } | tee report.md >> "$GITHUB_STEP_SUMMARY"

      - name: Update tracking issue
        if: always()
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            const title = 'Autopilot Nightly Report';
            const { owner, repo } = context.repo;
            const issues = await github.rest.issues.listForRepo({ owner, repo, state: 'open', per_page: 100 });
            const existing = issues.data.find(issue => issue.title === title && !issue.pull_request);
            if (existing) {
              await github.rest.issues.createComment({ owner, repo, issue_number: existing.number, body });
            } else {
              await github.rest.issues.create({ owner, repo, title, body });
            }
