<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenditures - PHI Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .filters-card { margin-bottom: 1.5rem; }
        .badge-verified { background-color: #00c853; }
        .badge-pending { background-color: #ff6d00; }
        .confidence-high { color: #00c853; }
        .confidence-medium { color: #ffd600; }
        .confidence-low { color: #d50000; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/"><i class="fas fa-chart-line"></i> PHI Expenditure Tracker</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/expenditures">Expenditures</a></li>
                    <li class="nav-item"><a class="nav-link" href="/verify">Verify</a></li>
                    <li class="nav-item"><a class="nav-link" href="/recurring">Recurring</a></li>
                    <li class="nav-item"><a class="nav-link" href="/reports">Reports</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <h2><i class="fas fa-list"></i> All Expenditures</h2>

        <!-- Filters -->
        <div class="card filters-card">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="startDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-control" id="endDate">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Company</label>
                        <select class="form-select" id="companyFilter">
                            <option value="">All Companies</option>
                            <option>Fractal5 Solutions Inc</option>
                            <option>Blue Wave Action Group Inc</option>
                            <option>Plane4 Grain Inc</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Verified</label>
                        <select class="form-select" id="verifiedFilter">
                            <option value="all">All</option>
                            <option value="true">Verified</option>
                            <option value="false">Pending</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="loadExpenditures()">
                            <i class="fas fa-search"></i> Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-table"></i> Results <span id="resultCount" class="badge bg-secondary">0</span></span>
                <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Company</th>
                                <th>Vendor</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="expendituresTable">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Expenditure Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailContent">
                    Loading...
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Set default dates (last 90 days)
        const today = new Date();
        const ninetyDaysAgo = new Date(today);
        ninetyDaysAgo.setDate(today.getDate() - 90);

        document.getElementById('endDate').valueAsDate = today;
        document.getElementById('startDate').valueAsDate = ninetyDaysAgo;

        async function loadExpenditures() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const company = document.getElementById('companyFilter').value;
            const verified = document.getElementById('verifiedFilter').value;

            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate,
                company: company,
                verified: verified,
                limit: 500
            });

            try {
                const response = await fetch(`/api/expenditures?${params}`);
                const data = await response.json();

                document.getElementById('resultCount').textContent = data.count;

                const table = document.getElementById('expendituresTable');
                if (data.expenditures.length === 0) {
                    table.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No expenditures found</td></tr>';
                    return;
                }

                table.innerHTML = data.expenditures.map(exp => `
                    <tr>
                        <td>${exp.date}</td>
                        <td><small>${exp.company.split(' ')[0]}</small></td>
                        <td>${exp.vendor}</td>
                        <td><small>${exp.description}</small></td>
                        <td><span class="badge bg-info">${exp.category || 'N/A'}</span></td>
                        <td class="text-end fw-bold">${exp.currency} $${exp.amount.toLocaleString()}</td>
                        <td>
                            ${exp.verified
                                ? '<span class="badge badge-verified"><i class="fas fa-check"></i> Verified</span>'
                                : `<span class="badge badge-pending">Pending</span>`}
                            <br><small class="confidence-${exp.confidence?.toLowerCase() || 'medium'}">${exp.confidence || 'MEDIUM'}</small>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${exp.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Error loading expenditures:', error);
                document.getElementById('expendituresTable').innerHTML =
                    '<tr><td colspan="8" class="text-center text-danger">Error loading data</td></tr>';
            }
        }

        async function viewDetails(id) {
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();

            document.getElementById('detailContent').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';

            try {
                const response = await fetch(`/api/expenditures/${id}`);
                const exp = await response.json();

                document.getElementById('detailContent').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Financial Details</h6>
                            <table class="table table-sm">
                                <tr><th>Amount:</th><td>${exp.currency} $${exp.amount.toLocaleString()}</td></tr>
                                <tr><th>Date:</th><td>${exp.date}</td></tr>
                                <tr><th>Category:</th><td>${exp.category || 'N/A'}</td></tr>
                                <tr><th>Tax:</th><td>${exp.tax_amount ? `$${exp.tax_amount} (${exp.tax_type})` : 'N/A'}</td></tr>
                                <tr><th>Tax Deductible:</th><td>${exp.tax_deductible ? 'Yes' : 'No'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Vendor Details</h6>
                            <table class="table table-sm">
                                <tr><th>Vendor:</th><td>${exp.vendor}</td></tr>
                                <tr><th>Email:</th><td>${exp.vendor_email || 'N/A'}</td></tr>
                                <tr><th>Invoice #:</th><td>${exp.invoice_number || 'N/A'}</td></tr>
                                <tr><th>Payment:</th><td>${exp.payment_method}</td></tr>
                                <tr><th>Status:</th><td>${exp.payment_status}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Description</h6>
                            <p>${exp.description}</p>
                            ${exp.notes ? `<h6>Notes</h6><p>${exp.notes}</p>` : ''}
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6>Data Source</h6>
                            <table class="table table-sm">
                                <tr><th>Source:</th><td>${exp.data_source}</td></tr>
                                <tr><th>Confidence:</th><td><span class="confidence-${exp.confidence?.toLowerCase()}">${exp.confidence}</span></td></tr>
                                <tr><th>Email ID:</th><td><small>${exp.source_email_id || 'N/A'}</small></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Verification</h6>
                            <table class="table table-sm">
                                <tr><th>Verified:</th><td>${exp.verified ? 'Yes' : 'No'}</td></tr>
                                <tr><th>Verified By:</th><td>${exp.verified_by || 'N/A'}</td></tr>
                                <tr><th>Verified At:</th><td>${exp.verified_at || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Audit Trail</h6>
                            <table class="table table-sm">
                                <tr><th>Created By:</th><td>${exp.created_by}</td></tr>
                                <tr><th>Created At:</th><td>${exp.created_at}</td></tr>
                                <tr><th>Ledger Hash:</th><td><code style="font-size: 0.7rem">${exp.ledger_hash}</code></td></tr>
                            </table>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading details:', error);
                document.getElementById('detailContent').innerHTML = '<div class="text-center text-danger">Error loading details</div>';
            }
        }

        function exportToCSV() {
            alert('CSV export feature coming soon!');
        }

        // Load on page load
        loadExpenditures();
    </script>
</body>
</html>
